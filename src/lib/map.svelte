<script>
	import 'leaflet/dist/leaflet.css';
	import { onMount, onDestroy } from 'svelte';
	import L from 'leaflet';
	import { browser } from '$app/environment';
	import * as trainingCenter from '../lib/service/trainingCenter';
	import { get } from 'svelte/store';
	import { json } from '@sveltejs/kit';
	import axios from 'axios';
	// import { trainingCenters } from './store/trainingCenter';
	export let division = null;
	export let district = null;
	export let subDistrict = null;
	export let startDate = null;
	export let endDate = null;
	export let viewType = null;

	let mapElement;
	let map;

	let markers = [];
	let info;

	let markerObjes = [];
	let trainingCenterData = [];
	let batchData = [];
	// $: latLong = getTrainingCenterMap.data.map((item) => ({ ...item, text: item.name }));
	async function getMapData(filter) {
		const { data } = await trainingCenter.getTrainingCenterMap(filter);
		console.log(data);
		trainingCenterData = data.training_center_data;
		batchData = data.batch_data;
	}
	const svgIcon = L.divIcon({
		html: `<svg width="36" height="36" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M36.9844 0.0937271C36.9219 0.156227 36.6094 0.218727 36.2813 0.234352C35.9688 0.249977 35.5 0.312477 35.2344 0.359352C34.9844 0.421852 34.5313 0.499977 34.2344 0.546852C33.9375 0.593727 33.5625 0.718727 33.375 0.812477C33.2031 0.906227 33.0313 0.968727 33 0.953102C32.8906 0.843727 30 1.67185 29.8438 1.85935C29.7969 1.90623 29.6563 1.96873 29.5313 1.99998C28.9688 2.10935 26.3594 3.40623 26.2813 3.62498C26.25 3.68748 26.1719 3.71873 26.0938 3.67185C26.0313 3.6406 25.8594 3.73435 25.7031 3.90623C25.5469 4.0781 25.3594 4.21873 25.2813 4.21873C25.1563 4.21873 23.9375 4.96873 23.75 5.15623C23.7031 5.2031 23.2813 5.53123 22.8125 5.87498C21.8281 6.60935 19.3906 8.96873 18.5938 9.98435C18.2969 10.3594 17.875 10.8437 17.6719 11.0781C17.4688 11.2969 17.2031 11.7187 17.0938 11.9844C16.9688 12.2656 16.7969 12.5 16.7188 12.5C16.625 12.5 16.5625 12.5781 16.5625 12.6719C16.5625 12.7656 16.4219 13.0469 16.2344 13.2969C16.0625 13.5469 15.9688 13.75 16.0313 13.75C16.0781 13.75 16.0469 13.8437 15.9531 13.9531C15.625 14.3594 14.5313 16.6094 14.5313 16.8906C14.5313 17.0625 14.4688 17.1875 14.375 17.1875C14.2969 17.1875 14.2188 17.3437 14.2188 17.5469C14.2188 17.75 14.1563 17.9687 14.0938 18.0469C13.8594 18.3125 13.3594 19.7656 13.2031 20.625C13.1875 20.75 13.125 20.9687 13.0938 21.0937C12.9219 21.5469 12.6875 22.5781 12.6875 22.8125C12.6875 23.1094 12.5469 23.8594 12.4531 24.0156C12.2656 24.3125 12.125 26.8906 12.1094 29.6875C12.1094 32.9219 12.2031 34.1562 12.5625 35.8906C12.6875 36.4844 12.8281 37.1406 12.8594 37.3437C13.0781 38.5469 13.8594 40.8437 14.7344 42.8906C15.2188 44.0156 16.7344 46.6875 17.0156 46.875C17.0781 46.9219 17.2656 47.1875 17.4219 47.4531C17.5938 47.7344 17.7813 47.9687 17.8594 47.9687C17.9219 47.9687 17.9375 48.0469 17.8906 48.125C17.8438 48.2187 17.9063 48.3281 18.0313 48.375C18.1719 48.4219 18.2813 48.5469 18.2813 48.6562C18.2813 48.75 18.5313 49.1094 18.8281 49.4375C19.125 49.7812 19.3281 50.1094 19.2813 50.1875C19.2344 50.25 19.3125 50.3594 19.4375 50.4062C19.5781 50.4531 19.6875 50.5781 19.6875 50.6875C19.6875 50.7812 19.9063 51.0937 20.1563 51.3906C20.4219 51.6719 20.625 52.0156 20.625 52.1406C20.625 52.25 20.7344 52.3906 20.8594 52.4375C20.9844 52.5 21.0938 52.625 21.0938 52.7187C21.0938 52.8281 21.3125 53.1562 21.5625 53.4375C21.8281 53.7187 22.0313 54.0156 22.0313 54.0937C22.0313 54.2812 23.0156 55.625 23.1719 55.625C23.2344 55.625 23.25 55.6875 23.2031 55.7812C23.1563 55.8594 23.1875 55.9375 23.2656 55.9375C23.3594 55.9375 23.4375 56.0469 23.4375 56.1719C23.4375 56.2969 23.5 56.4062 23.5781 56.4062C23.6563 56.4062 23.7656 56.5312 23.8281 56.7031C23.875 56.8594 24.0938 57.1875 24.2969 57.4062C24.5 57.625 24.6406 57.8125 24.6094 57.8125C24.5781 57.8125 24.7188 58 24.9219 58.2187C25.1406 58.4531 25.3125 58.7187 25.3125 58.8281C25.3125 58.9375 25.4844 59.2031 25.7031 59.4375C25.9063 59.6562 26.0313 59.8437 25.9844 59.8437C25.9375 59.8437 26.0781 60.0312 26.3125 60.25C26.5313 60.4844 26.7188 60.7344 26.7188 60.8281C26.7188 60.9375 27.3906 61.9375 28 62.7344C28.0781 62.8125 28.3125 63.1719 28.5469 63.5156C28.7656 63.8594 29.3438 64.7031 29.8125 65.3906C30.2969 66.0781 30.9219 66.9844 31.2188 67.4219C31.5313 67.8437 31.8281 68.2187 31.9063 68.25C31.9688 68.2812 32.0313 68.4062 32.0313 68.5312C32.0313 68.6562 32.0938 68.75 32.1719 68.75C32.25 68.75 32.3906 68.9531 32.4844 69.1875C32.5938 69.4219 32.8438 69.8125 33.0469 70.0469C33.2656 70.2656 33.4375 70.5312 33.4375 70.625C33.4375 70.7031 33.5 70.7812 33.5625 70.7812C33.6406 70.7812 33.8125 71.0312 33.9531 71.3281C34.0938 71.625 34.2813 71.875 34.375 71.875C34.4531 71.875 34.5313 71.9687 34.5313 72.0781C34.5313 72.1875 34.6719 72.4219 34.8281 72.6094C34.9844 72.7812 35.2344 73.1406 35.375 73.4062C35.5156 73.6875 35.7031 73.9062 35.7813 73.9062C35.875 73.9062 35.9375 73.9844 35.9375 74.0781C35.9375 74.2344 36.9375 75.7187 37.1875 75.9375C37.2344 75.9844 37.5 76.375 37.7813 76.8125C38.0625 77.25 38.4375 77.7812 38.6094 77.9844C38.7969 78.1875 39.0625 78.6094 39.2344 78.9062C39.6719 79.7344 39.9844 80.0781 40.125 79.9062C40.5 79.5 42.3438 76.7187 42.3438 76.5937C42.3438 76.5 42.4063 76.4062 42.4688 76.375C42.6719 76.3125 43.75 74.7656 43.75 74.5625C43.75 74.4687 43.7969 74.375 43.875 74.3437C44.0625 74.2656 45.1563 72.7187 45.1563 72.5312C45.1563 72.4375 45.2031 72.3437 45.2813 72.3125C45.4063 72.2656 46.5938 70.625 47.5781 69.1406C47.9219 68.625 48.2813 68.125 48.3594 68.0312C48.4531 67.9375 48.6563 67.6094 48.8281 67.2969C49 66.9844 49.1875 66.7187 49.25 66.7187C49.3281 66.7187 49.375 66.6094 49.375 66.4844C49.375 66.375 49.4688 66.2031 49.5781 66.1406C49.6875 66.0781 50.0469 65.5781 50.3594 65.0469C50.6875 64.5156 51 64.0625 51.0625 64.0312C51.125 64 51.4219 63.5937 51.7031 63.125C52 62.6562 52.3125 62.1875 52.4063 62.1094C52.5156 62.0156 52.8281 61.5781 53.1094 61.125C53.4063 60.6562 53.7188 60.2031 53.8125 60.1094C53.9063 60 54.25 59.5312 54.5625 59.0625C54.8906 58.5937 55.3594 57.9062 55.625 57.5312C55.875 57.1719 56.0938 56.7969 56.0938 56.7187C56.0938 56.6406 56.2188 56.5 56.375 56.4219C56.5156 56.3281 56.5781 56.25 56.4844 56.25C56.375 56.25 56.375 56.2031 56.4844 56.125C56.7344 55.9531 57.5 54.875 57.5 54.7187C57.5 54.625 57.6094 54.5156 57.75 54.4687C57.875 54.4219 57.9531 54.3125 57.9063 54.2344C57.8438 54.1562 57.8594 54.0625 57.9219 54.0312C58.0938 53.9687 59.4063 52.1875 59.2969 52.1875C59.25 52.1875 59.3438 52.0469 59.5156 51.8594C59.6719 51.6875 60.2969 50.8281 60.8906 49.9531C61.4688 49.0781 62 48.3437 62.0781 48.3125C62.1406 48.2812 62.1875 48.1875 62.1875 48.0937C62.1875 47.9531 62.4063 47.6562 63.125 46.7656C63.2188 46.6562 63.2813 46.5312 63.2813 46.4687C63.2813 46.4062 63.375 46.2344 63.5 46.1094C63.8438 45.7187 65.3125 42.8594 65.3125 42.5937C65.3125 42.4531 65.375 42.3437 65.4688 42.3437C65.5469 42.3437 65.6719 42.1562 65.7188 41.9062C65.7813 41.6719 65.9531 41.2031 66.1094 40.875C66.25 40.5312 66.3438 40.1719 66.2969 40.0469C66.25 39.9375 66.2969 39.8437 66.4063 39.8437C66.5 39.8437 66.5625 39.75 66.5156 39.6406C66.4844 39.5469 66.5938 39.0625 66.7656 38.5937C66.9219 38.125 67.0938 37.5625 67.125 37.3437C67.1563 37.125 67.2344 36.7812 67.2813 36.5625C67.3438 36.3437 67.4063 35.9531 67.4375 35.7031C67.5313 34.9844 67.6406 34.3437 67.75 33.9062C67.7969 33.6875 67.875 32.0312 67.8906 30.2344C67.9375 27.3125 67.8594 25.8594 67.5781 24.2969C67.5313 24.0312 67.4688 23.6562 67.4219 23.4375C67.2813 22.4844 67.1719 22.0469 66.875 21.0156C66.6875 20.4062 66.4844 19.6406 66.3906 19.2969C66.3125 18.9531 66.2031 18.5625 66.1406 18.4375C66.0938 18.3125 66.0313 18.1719 66.0156 18.125C66 18.0781 65.8906 17.8281 65.7813 17.5781C65.5469 17.0469 65.5625 17.0937 65.4063 16.5156C65.3281 16.2812 65.2188 16.0937 65.1406 16.0937C65.0625 16.0937 65 15.9844 65 15.8594C65 15.5469 64.2344 14 64.0469 13.9375C63.9688 13.9062 63.9063 13.7969 63.9063 13.6719C63.9063 13.5625 63.7969 13.3906 63.6719 13.2812C63.5469 13.1719 63.4375 12.9844 63.4375 12.8594C63.4375 12.7344 63.3438 12.5312 63.25 12.4219C62.8125 11.9375 62.6563 11.7344 62.6563 11.625C62.6563 11.5 61.5625 10.125 61.3281 9.96873C61.2344 9.8906 61.2344 9.84373 61.3281 9.84373C61.4063 9.84373 60.8438 9.23435 60.0625 8.46873C57.8906 6.37498 57.3906 5.93748 57.2656 5.93748C57.2031 5.93748 57.0156 5.78123 56.8594 5.59373C56.6875 5.42185 56.5625 5.3281 56.5625 5.40623C56.5625 5.48435 56.5 5.46873 56.4375 5.3906C56.2344 5.09373 54.1719 3.7031 53.9531 3.7031C53.8438 3.7031 53.75 3.6406 53.75 3.56248C53.75 3.49998 53.6563 3.43748 53.5313 3.43748C53.4219 3.43748 53.25 3.34373 53.1563 3.23435C53.0625 3.12498 52.5313 2.85935 51.9688 2.65623C51.4063 2.43748 50.9375 2.21873 50.9375 2.1406C50.9375 2.0781 50.8438 2.03123 50.7188 2.03123C50.6094 2.03123 50.2969 1.92185 50.0625 1.79685C49.8125 1.67185 49.4531 1.56248 49.2656 1.56248C49.0781 1.56248 48.8906 1.49998 48.8438 1.42185C48.7656 1.31248 48.0313 1.0781 47.5781 1.03123C47.5 1.0156 47.3438 0.953102 47.25 0.906227C47.1563 0.843727 46.8125 0.749977 46.5 0.718727C46.1875 0.687477 45.7031 0.578102 45.4219 0.484352C45.1563 0.390602 44.5 0.281227 43.9844 0.218727C42.4844 0.0624771 37.1094 -0.0312729 36.9844 0.0937271ZM42.625 18.7969C42.9531 18.9219 43.2813 19.0469 43.3594 19.0781C44.3125 19.3281 46.3594 20.7187 47.1719 21.6562C48.0938 22.7187 48.5781 23.5156 48.7031 24.1406C48.7344 24.2969 48.8125 24.4844 48.8906 24.5312C49 24.6094 49.0625 24.8125 49.3281 26.0156C49.4531 26.5937 49.4531 28.875 49.3281 29.2969C48.8125 31.0781 48.2969 32.3125 47.8594 32.7969C47.6563 33 47.5 33.2187 47.5 33.2969C47.5 33.4687 45.9688 34.9687 45.875 34.8906C45.8281 34.8437 45.7031 34.9531 45.5938 35.1406C45.4844 35.3281 45.3281 35.4687 45.25 35.4687C45.1719 35.4687 44.9844 35.5625 44.8594 35.6875C44.625 35.875 43.1406 36.4844 42.4219 36.6719C41.9531 36.7969 38.7031 36.8594 38.5156 36.75C38.4375 36.6875 38.2969 36.6406 38.2031 36.625C38.125 36.5937 37.9063 36.5625 37.7344 36.5156C37.1719 36.4062 35.0781 35.3281 34.6563 34.9219C34.4219 34.7031 34.1875 34.5312 34.1406 34.5312C33.625 34.5312 31.5781 31.2031 31.4531 30.1562C31.4219 29.9375 31.3281 29.5781 31.2656 29.3594C31.0313 28.6719 31.1719 25.9375 31.4688 25.0781C31.875 23.9375 32.3125 23 32.5 22.8906C32.5938 22.8281 32.625 22.7344 32.5781 22.6562C32.5313 22.5781 32.625 22.4219 32.8125 22.3125C32.9844 22.2031 33.125 22.0469 33.125 21.9844C33.125 21.7656 34.8438 20.1719 35.1719 20.0781C35.3438 20.0156 35.4688 19.9062 35.4688 19.8281C35.4688 19.7344 35.5469 19.7187 35.625 19.7656C35.7188 19.8125 35.7813 19.7812 35.7813 19.7031C35.7813 19.6094 35.9063 19.5312 36.0625 19.5312C36.2188 19.5312 36.4375 19.4375 36.5313 19.3437C36.7344 19.1406 37.8281 18.8281 38.9063 18.6562C39.2031 18.5937 39.4688 18.5469 39.4844 18.5312C39.625 18.4062 42.1875 18.625 42.625 18.7969Z" fill="#FF5F5F"/>
</svg>
`
	});

	$: {
		// if(startDate != null){
		// 	startDate = startDate.toString()

		// }
		let params = {
			division: division,
			district: district,
			sub_district: subDistrict,
			start_date: startDate,
			end_date: endDate
		};
		viewType;
		getMapData(params);
	}

	$: {
		if (viewType == 1) {
			markerObjes.forEach((item) => {
				map.removeLayer(item);
			});
			markerObjes = trainingCenterData.map((marker) => {
				return L.marker(marker.lat_long, { icon: svgIcon })
					.bindPopup(
						`Venue name: ${marker.name} <br> Division: ${marker.division} <br> District: ${marker.district} <br> Sub District: ${marker.sub_district}`
					)
					.addTo(map);
			});
		} else if (viewType == 2) {
			markerObjes.forEach((item) => {
				map.removeLayer(item);
			});
			markerObjes = batchData.map((marker) => {
				return L.marker(marker.lat_long, { icon: svgIcon })
					.bindPopup(
						`No of batch: ${marker.no_of_batch} <br> No of Trained Participants: ${marker.no_of_trainee} <br> Division: ${marker.division} <br> District: ${marker.district} <br> Sub District: ${marker.sub_district}`
					)
					.addTo(map);
			});
		}
	}
	let bangldesh =
		'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/7876441648e7068fcce200709394ad259b0ab428/releaseData/gbOpen/BGD/ADM0/geoBoundaries-BGD-ADM0_simplified.geojson';

	function mapBangladesh() {
		if (browser) {
			axios.get(bangldesh).then((resp) => {
				L.geoJson(resp.data, { color: 'green', fillColor: '#BDD8A1'}).addTo(map);
			});

			// axios.get(bangladeshZillas).then((resp) => {
			// 	let index = resp.data.features.findIndex((item) => item.properties.ADM2_EN == 'Dhaka');
			// 	L.geoJson(resp.data.features[index], {color: 'red'}).addTo(map);
			// });
		}
	}

	onMount(async () => {
		if (browser) {
			const leaflet = await import('leaflet');

			map = leaflet.map(mapElement).setView([23.8103, 90.4125], 7);
			map.options.minZoom = 7;

			leaflet
				.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution:
						'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				})
				.addTo(map);

			getMapData({});
			mapBangladesh();
		}
	});

	onDestroy(async () => {
		if (map) {
			console.log('Unloading Leaflet map.');
			map.remove();
		}
	});
</script>

<main>
	<div class="t-h-[70vh] t-z-10 t-w-100" bind:this={mapElement} />
</main>
